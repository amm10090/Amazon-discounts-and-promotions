# Amazon Deals ASIN 爬取功能文档

## 功能概述

本模块主要用于自动化爬取 Amazon Deals 页面中的商品 ASIN。通过模拟浏览器滚动和智能等待，实现对动态加载商品的有效采集。

## 核心功能

### 1. 页面加载与初始化
- 使用 Puppeteer 加载 Amazon Deals 页面
- 等待核心内容加载完成
- 检测反爬虫机制
- 初始化等待时间：3000ms

### 2. ASIN 采集策略

#### 2.1 商品定位
- 主容器选择器：`[data-testid="virtuoso-item-list"]`
- 商品项选择器：`[data-index]`
- ASIN 获取：从商品项的第二个 div 的 `data-testid` 属性获取

#### 2.2 滚动控制
- 首次滚动步长：400px
- 常规滚动步长：600px
- 使用平滑滚动：`behavior: 'smooth'`
- 滚动等待时间：
  - 首次滚动：2500ms
  - 常规滚动：1500ms
  - 加载更多：3000ms

#### 2.3 动态加载处理
- 检测 "View more deals" 按钮
- 自动点击加载更多
- 监控加载动画
- 检测页面高度变化

### 3. 采集限制
- 默认最大商品数量：200
- 可通过参数自定义限制
- 最大滚动尝试次数：50
- 连续无新ASIN最大次数：3

## 实现细节

### 1. 防止遗漏商品的措施
- 记录已收集的ASIN集合
- 比对新旧ASIN列表
- 连续采集次数计数
- 最后一次额外采集确认

### 2. 性能优化
- 使用 Set 数据结构去重
- 平滑滚动减少页面抖动
- 动态调整等待时间
- 智能判断采集终止条件

### 3. 异常处理
- 反爬虫检测
- 加载超时处理
- 点击事件失败处理
- 滚动异常处理

## 使用示例

```typescript
// 使用默认配置（最多200个商品）
const result = await DealsService.captureDealsPage();

// 自定义商品数量
const result = await DealsService.captureDealsPage(100);

// 返回结果
interface Result {
  screenshotPath: string;  // 截图保存路径
  asins: string[];        // 收集到的ASIN列表
}
```

## 输出文件

### 1. 截图
- 保存位置：`screenshots/amazon-deals-{timestamp}.png`
- 完整页面截图
- 时间戳格式：ISO 格式（替换":"为"-"）

### 2. ASIN数据
- 保存位置：`data/asins-{timestamp}.json`
- 包含信息：
  - 时间戳
  - 执行时长
  - 目标商品数
  - 实际采集数
  - 采集速度
  - ASIN列表
  - 截图路径

## 注意事项

1. **性能考虑**
   - 首次加载给予充足等待时间
   - 滚动速度要适中，不能过快
   - 需要给页面足够的渲染时间

2. **稳定性考虑**
   - 实现了连续无新ASIN的检测
   - 设置了最大尝试次数限制
   - 添加了多重终止条件

3. **可能的问题**
   - 页面结构变化可能导致选择器失效
   - 网络延迟可能需要调整等待时间
   - 反爬虫机制可能导致采集中断

## 后续优化方向

1. 添加重试机制
2. 优化等待时间动态调整
3. 增加更多的状态检查
4. 添加代理支持
5. 优化内存使用
6. 添加断点续传功能
7. 增加并发采集支持 